# <span style="color:#4f46e5">Конвертер валют</span>
Стек:
 - PHP v8.0.30
 - Laravel v8.83.27
 - MySQL v8.0.17
 - Tailwindcss v3.4.1
 - Node v21.6.0
 - npm v10.3.0


## I. Запуск с помощью Docker
1. Выполнить `docker compose up -d` и дождаться окончания работы
1. Открыть браузер и перейти на localhost:8081

## II. Обычный запуск
Создать файл `.env` в корне проекта на основе `.env.example`
##### Выполнить в корне проекта:
1. sql-скрипт в каталоге `database/scripts/init_database.sql` (для инициализации БД MySQL, должна быть установлена СУБД MySQL)
1. `php composer.phar install` (установка зависимостей для Laravel)
1. `php artisan key:generate` (генерация ключа приложения для Laravel)
1. `php artisan migrate:fresh --seed` (развертывание необходимых таблиц для MySQL и пользователя для приложения, посмотреть миграции можно по пути `database/migrations`, создание пользователя `database/seeders/UserSeeder.php`)
1. `npm install` (установка зависимостей для frontend)
1. `npm run prod` (развертывание frontend)
1. `php artisan schedule:work` (запуск планировщика для выполнения команды получения курсов валют, посмотреть команду можно по пути `app/Console/Commands/GetRates.php`)
1. `php artisan serve --host=0.0.0.0 --port=8081` (запуск локального веб-сервера)
1. (Optional) `php artisan get-rates` (непосредственное выполнение команды получения курсов валют)
1. Открыть браузер и перейти на localhost:8081

## Детальное описание
Если у вас установлены `docker`, `docker compose` etc, то это будет самый простой способ запуска приложения.
Так как все манипуляции для развертывания приложения происходят с помощью `Docker`.

Расположение файлов для `Docker` (в корне проекта):
- каталог `_docker`
- файл `.env.docker`
- файл `docker-compose.yml`

### Файл `docker-compose.yml`
Здесь происходит создание трех контейнеров:
- **currency-convert**<br/>
Создание образа для контейнера происходит с помощью файла `_docker/app/Dockerfile`. За основу взят образ `php:8.0`.<br/>
Здесь непосредственно происходит установка всех зависимостей для приложения.<br/>
Также здесь в `ENTRYPOINT` прокидывается скрипт `_docker/docker-entrypoint.sh` в котором происходит ожидание запуска контейнера с СУБД MySQL `db`, чтобы потом выполнить команды для инициализации приложения: `php artisan migrate:fresh --seed` (создание всех таблиц и пользователя) и `php artisan get-rates` (первоначальная инициализация таблицы курса валют).<br/>
И под конец запуск локального веб-сервера `php artisan serve --host=0.0.0.0 --port=8081`
- **db**<br/>
За основу взят готовый образ `mysql:8.0.17`. Здесь происходит инициализация MYSQL с помощью прокинутого скрипта `database/scripts/init_database.sql`: создание БД с наименованием `curr_conv`, также пользователя БД с аналогичным именем, пароля для него и выдача всех привилегий.<br/>
Как описано выше контейнер `currency-convert` будет дожидаться выполнения этой инициализации.<br/>
(Optional) Для проверки и манипуляций для локального хоста прокинут порт `33061`.
- **sheduler**<br/>
Создание образа для контейнера происходит с помощью файла `_docker/sheduler/Dockerfile`. За основу взят образ `php:8.0`.<br/>
Здесь происходит установка `cron` и выдача необходимых прав, создание лога и т.п.<br/>
В `crontab` прокидывается скрипт `_docker/shedule-script` в котором каждую минуту `cron` выполняет специальную команду Laravel `php artisan schedule:run`.<br/>
Команда `schedule:run` анализирует все запланированные задачи и определяет, нужно ли их запускать, исходя из текущего времени сервера.
В данном приложении определена только одна команда `get-rates` (получение курсов валют), которая будет запускаться каждые 2 минуты. Такой небольшой интервал сделан только в целях тестирования.<br/>
Определение этой команды для запуска в планировщике можно посмотреть тут: `app/Console/Kernel.php`

Основная алгоритмическая часть находится здесь:
- `app/Http/Controllers/ConvertController.php`
- `app/Console/Commands/GetRates.php`

<span style="color:#700b21; font-weight:bold">! Всевозможные проверки на корректность ввода, типов и т.д. сделаны достаточно минимальными. !</span>

## Работа с приложением
Приложение открывается по адресу: `http://localhost:8081`. В верхнем правом углу располагается ссылка для входа в приложение "Войти".

![Начальная страница](https://raw.githubusercontent.com/slavatrudu/currency_converter/365510a4f6785b8636e088b73886d31019a2ec45/CurrencyConverter_InitialPage.png)
<br/><br/>

После перехода по ссылке "Войти" открывается окно входа в приложение в которое необходимо ввести пользователя со следующими учетными данными:
- Email: `admin@email.ru`
- Password: `password`

![Страница входа](https://raw.githubusercontent.com/slavatrudu/currency_converter/365510a4f6785b8636e088b73886d31019a2ec45/CurrencyConverter_Login.png)

После входа открывается основное окно приложения:

![Основная страница после входа](https://raw.githubusercontent.com/slavatrudu/currency_converter/365510a4f6785b8636e088b73886d31019a2ec45/CurrencyConverter_Dashboard1.png)

По умолчанию выставляется курс валют USD <=> RUB.
Если "Дата расчета" не указана (см. ниже), то необходимо нажать кнопку "Обновить курс".
<br/><br/>
Выполнение команды `get-rates` для обновления курса валют происходит в 3 местах:
1. Единоразово в `ENTRYPOINT` для первоначальной инициализации. В этом месте она возможно может быть не выполнена, так как в некоторых случаях происходило определение DDoS.
2. С помощью планировщика каждые 2 минуты (напоминаю, что такой интервал только ради тестирования)
3. В интерфейсе приложения с помощью кнопки "Обновить курс"

![Основная страница с примером курса валют](https://raw.githubusercontent.com/slavatrudu/currency_converter/365510a4f6785b8636e088b73886d31019a2ec45/CurrencyConverter_Dashboard2.png)

"Дата расчета" означает, когда ЦБР произвел обновление курса валют из атрибута `ValCurs` (например, `<ValCurs Date="20.01.2024" name="Foreign Currency Market">`)

"Последнее обновление" означает, когда последний раз выполнялась команда обновления курса валют `get-rates`.
